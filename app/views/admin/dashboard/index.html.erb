<%= render 'admin/notice_and_alert' %>

<div class="container-fluid px-4">

  <h2 class="mt-3">DASHBOARD</h2>
  <p class="text-muted">This page contains of </p>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">

    <!-- Users Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow h-100 border-primary">

        <div class="card-header bg-primary text-white py-2">
          <h6 class="mb-0"><i class="bi bi-person-check"></i> Users</h6>
        </div>

        <div class="card-body p-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Total</span>
            <span class="fs-4 fw-bold"><%= @total_users %></span>
          </div>

          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: <%= @total_users > 0 ? (@active_users.to_f / @total_users * 100).round : 0 %>%"></div>
          </div>

          <div class="d-flex justify-content-between align-items-center small">
            <span><i class="bi bi-check-circle text-success"></i> Active</span>
            <span class="badge bg-success"><%= @active_users %></span>
          </div>

          <div class="d-flex justify-content-between align-items-center small mt-1">
            <span><i class="bi bi-x-circle text-danger"></i> Inactive</span>
            <span class="badge bg-danger"><%= @inactive_users %></span>
          </div>

        </div>
      </div>
    </div>

    <!-- Cards Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow h-100 border-success">

        <div class="card-header bg-success text-white py-2">
          <h6 class="mb-0"><i class="bi bi-credit-card"></i> Access Cards</h6>
        </div>

        <div class="card-body p-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Total</span>
            <span class="fs-4 fw-bold"><%= @total_cards %></span>
          </div>

          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: <%= @total_cards > 0 ? (@active_cards.to_f / @total_cards * 100).round : 0 %>%"></div>
          </div>

          <div class="d-flex justify-content-between align-items-center small">
            <span><i class="bi bi-check-circle text-success"></i> Active</span>
            <span class="badge bg-success"><%= @active_cards %></span>
          </div>

          <div class="d-flex justify-content-between align-items-center small mt-1">
            <span><i class="bi bi-x-circle text-danger"></i> Inactive</span>
            <span class="badge bg-danger"><%= @inactive_cards %></span>
          </div>

        </div>
      </div>
    </div>

    <!-- Schedules Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow h-100 border-info">

        <div class="card-header bg-info text-white py-2">
          <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Schedules</h6>
        </div>

        <div class="card-body p-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Total</span>
            <span class="fs-4 fw-bold"><%= @total_schedules %></span>
          </div>

          <div class="d-flex flex-column gap-1 mt-2">
            <div class="d-flex justify-content-between align-items-center small">
              <span><i class="bi bi-calendar3 text-primary"></i> Semester</span>
              <span class="badge bg-primary"><%= @semester %></span>
            </div>

            <div class="d-flex justify-content-between align-items-center small">
              <span><i class="bi bi-mortarboard text-primary"></i> School Year</span>
              <span class="badge bg-primary"><%= @school_year %></span>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Rooms Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow h-100 border-danger">

        <div class="card-header bg-danger text-white py-2">
          <h6 class="mb-0"><i class="bi bi-door-closed"></i> Rooms</h6>
        </div>

        <div class="card-body p-3">
          <div class="row g-0">

            <!-- Status -->
            <div class="col-6 border-end">
              <p class="text-center mb-1 small fw-bold text-muted">STATUS</p>
              <div class="d-flex flex-column gap-1">

                <div class="d-flex justify-content-between align-items-center small">
                  <span class="text-success"><i class="bi bi-circle-fill"></i> Available</span>
                  <span class="badge bg-success"><%= @available_rooms %></span>
                </div>

                <div class="d-flex justify-content-between align-items-center small">
                  <span class="text-danger"><i class="bi bi-circle-fill"></i> Unavailable</span>
                  <span class="badge bg-danger"><%= @unavailable_rooms %></span>
                </div>

              </div>
            </div>

            <!-- Occupancy -->
            <div class="col-6">
              <p class="text-center mb-1 small fw-bold text-muted">OCCUPANCY</p>
              <div class="d-flex flex-column gap-1">

                <div class="d-flex justify-content-between align-items-center small">
                  <span class="text-secondary"><i class="bi bi-door-open"></i> Vacant</span>
                  <span class="badge bg-secondary"><%= @vacant_rooms %></span>
                </div>

                <div class="d-flex justify-content-between align-items-center small">
                  <span class="text-warning"><i class="bi bi-door-closed"></i> Occupied</span>
                  <span class="badge bg-warning text-dark"><%= @occupied_rooms %></span>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RECENT ACITVITIES -->
  <div class="row mb-4">

    <!-- Time Tracking Activity -->
    <div class="col-12 col-lg-6 mb-4 mb-lg-0">
      <div class="card shadow h-100">

        <div class="recent_header card-header text-white d-flex justify-content-between align-items-center py-2">
          <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Time Tracking Activity</h6>
          <% if @recent_time_tracks && @recent_time_tracks.any? %>
            <span class="badge bg-light text-dark"><%= @recent_time_tracks.count %> entries</span>
          <% end %>
        </div>

        <div class="card-body p-0">
          <% if @recent_time_tracks && @recent_time_tracks.any? %>
            <div class="table-responsive">

              <table class="table table-hover table-striped mb-0">

                <thead class="table-light">
                  <tr>
                    <th>User</th>
                    <th>Room</th>
                    <th>Status</th>
                    <th>Time</th>
                  </tr>
                </thead>

                <tbody>
                <% @recent_time_tracks.each do |track| %>
                  <tr>
                    <td class="align-middle">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle text-secondary me-2"></i>

                        <div>
                          <div class="fw-bold"><%= track.user.firstname %> <%= track.user.lastname %></div>
                          <small class="text-muted"><%= track.card.uid if track.card %></small>
                        </div>

                      </div>
                    </td>

                    <td class="align-middle">
                      <span class="badge bg-info">Room <%= track.room.room_number if track.room %></span>
                    </td>

                    <td class="align-middle">
                      <% if track.status == 0 %>
                        <span class="badge bg-success">Time In</span>
                      <% else %>
                        <span class="badge bg-warning text-dark">Time Out</span>
                      <% end %>
                    </td>

                    <td class="align-middle">
                      <% time_value = track.status == 0 ? track.time_in : track.time_out %>
                      <%= time_value %>
                    </td>

                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-clock-history fs-1"></i>
              <p class="mt-2">No recent activity found</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Today's Room Usage -->
    <div class="col-12 col-lg-6">
      <div class="card shadow h-100">

        <div class="recent_header card-header text-white d-flex justify-content-between align-items-center py-2">
          <h6 class="mb-0"><i class="bi bi-door-open"></i> Today's Room Usage</h6>
          <% current_day = Date.today.strftime("%A") %>
          <span class="badge bg-light text-dark"><%= current_day %></span>
        </div>

        <div class="card-body p-0">
          <% if @todays_schedules && @todays_schedules.any? %>
            <div class="table-responsive">

              <table class="table table-hover table-striped mb-0">

                <thead class="table-light">
                  <tr>
                    <th>Room</th>
                    <th>Subject</th>
                    <th>Professor</th>
                    <th>Time</th>
                  </tr>
                </thead>

                <tbody>
                <% @todays_schedules.each do |schedule| %>
                  <tr>
                    <td class="align-middle">
                      <span class="badge bg-info">Room <%= schedule.room_id %></span>
                    </td>
                    <td class="align-middle fw-bold"><%= schedule.subject %></td>
                    <td class="align-middle">
                      <%= schedule.user.firstname %> <%= schedule.user.lastname %>
                    </td>
                    <td class="align-middle">
                      <small class="fw-bold"><%= schedule.start_time.strftime('%I:%M %p') %> - <%= schedule.end_time.strftime('%I:%M %p') %></small>
                    </td>
                  </tr>
                <% end %>
                </tbody>

              </table>
            </div>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-calendar-x fs-1"></i>
              <p class="mt-2">No schedules for today</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Room Schedules -->
  <div class="card shadow mb-4">
    <div class="recent_header card-header text-white d-flex justify-content-between align-items-center py-2">
      <h6 class="mb-0"><i class="bi bi-calendar"></i> Room Schedules - School Year <%= @school_year %></h6>

      <div>
        <select class="form-select form-select-sm" id="roomFilterDropdown">
          <option value="all">All Rooms</option>
          <% @room_schedules.sort_by { |room_number, _| room_number.to_i }.each do |room_number, _| %>
            <option value="<%= room_number %>">Room <%= room_number %></option>
          <% end %>
        </select>
      </div>

    </div>

    <div class="card-body p-0">
      <% if @room_schedules.any? %>
        <div class="accordion" id="roomSchedulesAccordion">
          <% @room_schedules.sort_by { |room_number, _| room_number.to_i }.each_with_index do |(room_number, schedules), index| %>
            <div class="accordion-item room-schedule-item" data-room="<%= room_number %>">
              <h2 class="accordion-header" id="heading<%= room_number %>">
                <button class="accordion-button <%= index == 0 ? '' : 'collapsed' %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= room_number %>" aria-expanded="<%= index == 0 ? 'true' : 'false' %>" aria-controls="collapse<%= room_number %>">
                  <div class="d-flex align-items-center w-100">
                    <span class="me-2"><i class="bi bi-door-closed"></i> Room <%= room_number %></span>
                    <span class="badge bg-primary ms-auto"><%= schedules.count %> schedules</span>
                  </div>
                </button>
              </h2>
              <div id="collapse<%= room_number %>" class="accordion-collapse collapse <%= index == 0 ? 'show' : '' %>" aria-labelledby="heading<%= room_number %>" data-bs-parent="#roomSchedulesAccordion">
                <div class="accordion-body p-0">
                  <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                      <thead class="table-dark">
                      <tr>
                        <th style="width: 14.28%">Monday</th>
                        <th style="width: 14.28%">Tuesday</th>
                        <th style="width: 14.28%">Wednesday</th>
                        <th style="width: 14.28%">Thursday</th>
                        <th style="width: 14.28%">Friday</th>
                        <th style="width: 14.28%">Saturday</th>
                        <th style="width: 14.28%">Sunday</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr>
                        <% ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].each do |day| %>
                          <td class="p-2">
                            <div class="d-flex flex-column gap-2">
                              <% schedules_for_day = schedules.select { |s| s.day == day }.sort_by { |s| s.start_time.seconds_since_midnight } %>
                              <% if schedules_for_day.any? %>
                                <% schedules_for_day.each do |schedule| %>
                                  <div class="card schedule-card bg-light">
                                    <div class="card-body p-2">
                                      <h6 class="card-title mb-1"><%= schedule.subject %></h6>
                                      <p class="card-text text-muted mb-1 small">
                                        <i class="bi bi-person me-1"></i> <%= schedule.user.firstname %> <%= schedule.user.lastname %>
                                      </p>
                                      <p class="card-text small fw-bold">
                                        <i class="bi bi-clock me-1"></i> <%= schedule.start_time.strftime('%I:%M %p') %> - <%= schedule.end_time.strftime('%I:%M %p') %>
                                      </p>
                                    </div>
                                  </div>
                                <% end %>
                              <% else %>
                                <div class="text-center text-muted py-3">
                                  <i class="bi bi-x-circle"></i> No Schedule
                                </div>
                              <% end %>
                            </div>
                          </td>
                        <% end %>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-calendar-x fs-1"></i>
          <p class="mt-3">No active room schedules available</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Internal CSS, too short -->
<style>
  .recent_header{
      background-color: #06441b;
  }
</style>

<!-- JS for Room Filter -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const roomFilter = document.getElementById('roomFilterDropdown');
        const roomItems = document.querySelectorAll('.room-schedule-item');

        roomFilter.addEventListener('change', function() {
            const selectedRoom = this.value;

            roomItems.forEach(item => {
                if (selectedRoom === 'all' || item.dataset.room === selectedRoom) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
</script>
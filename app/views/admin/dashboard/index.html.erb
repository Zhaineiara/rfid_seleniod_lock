<%= stylesheet_link_tag "dashboard.css", "data-turbo-track": "reload" %>
<%= stylesheet_link_tag "table.css", "data-turbo-track": "reload" %>

<%= render 'admin/notice_and_alert' %>

<div class="container-fluid px-4">

  <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
    <div>
      <h2 class="fw-bold">DASHBOARD</h2>
      <p class="text-muted">Overview of system statistics and activities</p>
    </div>
    <div class="d-flex align-items-center">
      <span class="badge bg-primary p-2 me-2"><i class="bi bi-calendar3"></i> <%= @semester %></span>
      <span class="badge bg-secondary p-2"><i class="bi bi-mortarboard"></i> <%= @school_year %></span>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="row g-3 mb-4">

    <!-- Users Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card_border_box card dashboard-card h-100 shadow-sm position-relative overflow-hidden zoom-effect">
        <div class="card-body p-3">

          <div class="d-flex justify-content-between mb-2">
            <div>
              <h6 class="fw-bold text-primary mb-0"><i class="bi bi-person-check"></i> Users</h6>
              <p class="text-muted small mb-0">Total registered users</p>
            </div>
            <div class="stat-icon bg-primary-light rounded-circle d-flex align-items-center justify-content-center pulsate">
              <i class="bi bi-people fs-4 text-primary"></i>
            </div>
          </div>

          <h3 class="mb-0 mt-3 fw-bold counter" data-target="<%= @total_users %>">0</h3>

          <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-1 small">
              <span><i class="bi bi-check-circle text-success"></i> Active</span>
              <div>
                <span class="badge bg-success counter" data-target="<%= @active_users %>">0</span>
                <small class="text-muted">(<span class="percentage"><%= @total_users > 0 ? (@active_users.to_f / @total_users * 100).round : 0 %></span>%)</small>
              </div>
            </div>

            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-success progress-animate" style="width: 0%" data-width="<%= @total_users > 0 ? (@active_users.to_f / @total_users * 100).round : 0 %>%"></div>
            </div>

            <div class="d-flex justify-content-between align-items-center small mt-2">
              <span><i class="bi bi-x-circle text-danger"></i> Inactive</span>
              <div>
                <span class="badge bg-danger counter" data-target="<%= @inactive_users %>">0</span>
                <small class="text-muted">(<span class="percentage"><%= @total_users > 0 ? (@inactive_users.to_f / @total_users * 100).round : 0 %></span>%)</small>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Cards Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card_border_box card dashboard-card h-100 shadow-sm position-relative overflow-hidden zoom-effect">
        <div class="card-body p-3">

          <div class="d-flex justify-content-between mb-2">
            <div>
              <h6 class="fw-bold text-success mb-0"><i class="bi bi-credit-card"></i> Access Cards</h6>
              <p class="text-muted small mb-0">Total registered cards</p>
            </div>
            <div class="stat-icon bg-success-light rounded-circle d-flex align-items-center justify-content-center pulsate">
              <i class="bi bi-credit-card-2-front fs-4 text-success"></i>
            </div>
          </div>

          <h3 class="mb-0 mt-3 fw-bold counter" data-target="<%= @total_cards %>">0</h3>

          <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-1 small">
              <span><i class="bi bi-check-circle text-success"></i> Active</span>
              <div>
                <span class="badge bg-success counter" data-target="<%= @active_cards %>">0</span>
                <small class="text-muted">(<span class="percentage"><%= @total_cards > 0 ? (@active_cards.to_f / @total_cards * 100).round : 0 %></span>%)</small>
              </div>
            </div>

            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-success progress-animate" style="width: 0%" data-width="<%= @total_cards > 0 ? (@active_cards.to_f / @total_cards * 100).round : 0 %>%"></div>
            </div>

            <div class="d-flex justify-content-between align-items-center small mt-2">
              <span><i class="bi bi-x-circle text-danger"></i> Inactive</span>
              <div>
                <span class="badge bg-danger counter" data-target="<%= @inactive_cards %>">0</span>
                <small class="text-muted">(<span class="percentage"><%= @total_cards > 0 ? (@inactive_cards.to_f / @total_cards * 100).round : 0 %></span>%)</small>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Schedules Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card_border_box card dashboard-card h-100 shadow-sm position-relative overflow-hidden zoom-effect">
        <div class="card-body p-3">

          <div class="d-flex justify-content-between mb-2">
            <div>
              <h6 class="fw-bold text-info mb-0"><i class="bi bi-calendar-check"></i> Schedules</h6>
              <p class="text-muted small mb-0">Academic schedules</p>
            </div>
            <div class="stat-icon bg-info-light rounded-circle d-flex align-items-center justify-content-center pulsate">
              <i class="bi bi-calendar3-week fs-4 text-info"></i>
            </div>
          </div>

          <h3 class="mb-0 mt-3 fw-bold counter" data-target="<%= @total_schedules %>">0</h3>

          <div class="d-flex flex-column gap-2 mt-3">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <span class="badge bg-info p-2"><i class="bi bi-calendar3"></i></span>
              </div>
              <div class="flex-grow-1 ms-2 d-flex justify-content-between align-items-center">
                <span class="small">Current Semester</span>
                <span class="badge bg-dark fade-in"><%= @semester %></span>
              </div>
            </div>

            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <span class="badge bg-primary p-2"><i class="bi bi-mortarboard"></i></span>
              </div>
              <div class="flex-grow-1 ms-2 d-flex justify-content-between align-items-center">
                <span class="small">School Year</span>
                <span class="badge bg-dark fade-in"><%= @school_year %></span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Rooms Summary -->
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card_border_box card dashboard-card h-100 shadow-sm position-relative overflow-hidden zoom-effect">
        <div class="card-body p-3">

          <div class="d-flex justify-content-between mb-2">
            <div>
              <h6 class="fw-bold text-danger mb-0"><i class="bi bi-door-closed"></i> Rooms</h6>
              <p class="text-muted small mb-0">Classroom status</p>
            </div>
            <div class="stat-icon bg-danger-light rounded-circle d-flex align-items-center justify-content-center pulsate">
              <i class="bi bi-building fs-4 text-danger"></i>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-6">
              <div class="card border-0 bg-light hover-lift">
                <div class="card-body p-2 text-center">
                  <h6 class="small fw-bold text-muted mb-2">STATUS</h6>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="d-flex align-items-center small">
                      <i class="bi bi-circle-fill text-success me-1"></i> Available
                    </span>
                    <span class="badge bg-success counter" data-target="<%= @available_rooms %>">0</span>
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <span class="d-flex align-items-center small">
                      <i class="bi bi-circle-fill text-danger me-1"></i> Unavailable
                    </span>
                    <span class="badge bg-danger counter" data-target="<%= @unavailable_rooms %>">0</span>
                  </div>

                </div>
              </div>
            </div>

            <div class="col-6">
              <div class="card border-0 bg-light hover-lift">
                <div class="card-body p-2 text-center">
                  <h6 class="small fw-bold text-muted mb-2">OCCUPANCY</h6>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="d-flex align-items-center small">
                      <i class="bi bi-door-open text-secondary me-1"></i> Vacant
                    </span>
                    <span class="badge bg-secondary counter" data-target="<%= @vacant_rooms %>">0</span>
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <span class="d-flex align-items-center small">
                      <i class="bi bi-door-closed text-warning me-1"></i> Occupied
                    </span>
                    <span class="badge bg-warning text-dark counter" data-target="<%= @occupied_rooms %>">0</span>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RECENT ACTIVITIES -->
  <div class="row mb-4">

    <!-- Time Tracking Activity -->
    <div class="col-12 col-lg-6 mb-4 mb-lg-0">
      <div class="card shadow h-100">

        <div class="recent_header card-header d-flex justify-content-between align-items-center py-2">
          <h6 class="mb-0 fw-bold"><i class="bi bi-clock-history"></i> Recent Time Tracking Activity</h6>
          <% if @recent_time_tracks.present? && @recent_time_tracks.total_count > 0 %>
            <span class="badge bg-light text-dark"><%= @recent_time_tracks.total_count %> entries</span>
          <% end %>
        </div>

        <div class="card-body p-3">
          <% if @recent_time_tracks.present? && @recent_time_tracks.any? %>

            <div class="table-responsive">
              <table class="table table-hover table-striped mb-0">

                <thead class="table-light">
                <tr>
                  <th>User</th>
                  <th>Room</th>
                  <th>Status</th>
                  <th>Time</th>
                </tr>
                </thead>

                <tbody>
                <% @recent_time_tracks.each do |track| %>
                  <tr>

                    <td>
                      <div class="d-flex align-items-center">
                        <div>
                          <% if track.user.present? %>
                            <div class="fw-bold"><%= track.user.firstname %> <%= track.user.lastname %></div>
                          <% else %>
                            <div class="fw-bold">Unknown User</div>
                          <% end %>
                          <small class="text-muted">
                            <% if track.card.present? %>
                              <%= track.card.uid %>
                            <% else %>
                              No Card
                            <% end %>
                          </small>
                        </div>
                      </div>
                    </td>

                    <td>
                      <% if track.room.present? %>
                        <span>Room <%= track.room.room_number %></span>
                      <% else %>
                        <span>Unknown Room</span>
                      <% end %>
                    </td>

                    <td>
                      <% if track.status == 0 %>
                        <span class="badge bg-success"><i class="bi bi-box-arrow-in-right me-1"></i>Time In</span>
                      <% else %>
                        <span class="badge bg-warning text-dark"><i class="bi bi-box-arrow-right me-1"></i>Time Out</span>
                      <% end %>
                    </td>

                    <td>
                      <% raw_time = track.status == 0 ? track.time_in : track.time_out %>
                      <% time_value = raw_time.to_time %>
                      <span class="badge bg-light text-dark">
                        <i class="bi bi-clock me-1"></i>
                        <%= time_value.strftime("%B %-d, %Y %-l:%M%P") %>
                      </span>
                    </td>

                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-center">
              <div class="pagination">
                <%= paginate @recent_time_tracks, param_name: :time_track_page %>
              </div>
            </div>

          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-clock-history fs-1"></i>
              <p class="mt-2">No recent activity found</p>
            </div>
          <% end %>

        </div>
      </div>
    </div>

    <!-- Today's Room Usage -->
    <div class="col-12 col-lg-6">
      <div class="card shadow h-100">

        <div class="recent_header card-header d-flex justify-content-between align-items-center py-2">
          <h6 class="mb-0 fw-bold"><i class="bi bi-door-open"></i> Today's Room Usage</h6>
          <% current_day = Time.current.strftime("%A, %l:%M %p") %>
          <span class="badge bg-light text-dark"><i class="bi bi-calendar2-day me-1"></i><%= current_day %></span>
        </div>

        <div class="card-body p-3">
          <% if @todays_schedules.present? && @todays_schedules.any? %>

            <div class="table-responsive">
              <table class="table table-hover table-striped mb-0">

                <thead class="table-light">
                <tr>
                  <th>Room</th>
                  <th>Subject</th>
                  <th>Professor</th>
                  <th>Time</th>
                </tr>
                </thead>

                <tbody>
                <% @todays_schedules.each do |schedule| %>
                  <tr>
                    <td>
                      <% room = Room.find_by(id: schedule.room_id) %>
                      <% if room.present? %>
                          <span><i class="bi bi-door-closed me-1"></i>Room <%= room.room_number %>
                          </span>
                      <% else %>
                          <span><i class="bi bi-door-closed me-1"></i>Room <%= schedule.room_id %>
                          </span>
                      <% end %>
                    </td>

                    <td class="fw-bold"><%= schedule.subject %></td>

                    <td>
                      <div class="d-flex align-items-center">
                        <div>
                          <% if schedule.user.present? %>
                            <%= schedule.user.firstname %> <%= schedule.user.lastname %>
                          <% else %>
                            Unknown Professor
                          <% end %>
                        </div>
                      </div>
                    </td>

                    <td>
                        <span class="badge bg-light text-dark">
                          <i class="bi bi-clock me-1"></i>
                          <%= schedule.start_time.strftime('%I:%M %p') %> - <%= schedule.end_time.strftime('%I:%M %p') %>
                        </span>
                    </td>

                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>

            <div class="p-3 d-flex justify-content-center">
              <div class="pagination">
                <%= paginate @todays_schedules, param_name: :schedule_page %>
              </div>
            </div>

          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-calendar-x fs-1"></i>
              <p class="mt-2">No schedules for today</p>
            </div>
          <% end %>

        </div>
      </div>
    </div>
  </div>

  <!-- Room Schedules -->
  <div class="card shadow mb-4">

    <div class="card-header d-flex justify-content-between align-items-center py-2">
      <h6 class="mb-0 fw-bold"><i class="bi bi-calendar"></i> Room Schedules - School Year <%= @school_year %></h6>
      <div class="d-flex">
        <select class="form-select form-select-sm bg-light" id="roomFilterDropdown">
          <option value="all">All Rooms</option>
          <% @room_schedules.sort_by { |room_number, _| room_number.to_i }.each do |room_number, _| %>
            <option value="<%= room_number %>">Room <%= room_number %></option>
          <% end %>
        </select>
      </div>
    </div>

    <div class="card-body p-0">
      <% if @room_schedules.any? %>
        <div class="accordion" id="roomSchedulesAccordion">
          <% @room_schedules.sort_by { |room_number, _| room_number.to_i }.each_with_index do |(room_number, schedules), index| %>
            <div class="accordion-item room-schedule-item" data-room="<%= room_number %>">
              <h2 class="accordion-header" id="heading<%= room_number %>">
                <button class="accordion-button <%= index == 0 ? '' : 'collapsed' %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= room_number %>" aria-expanded="<%= index == 0 ? 'true' : 'false' %>" aria-controls="collapse<%= room_number %>">
                  <div class="d-flex align-items-center w-100">
                    <span class="me-2"><i class="bi bi-door-closed"></i> Room <%= room_number %></span>
                    <span class="badge bg-primary ms-auto"><%= schedules.count %> schedules</span>
                  </div>
                </button>
              </h2>

              <div id="collapse<%= room_number %>" class="accordion-collapse collapse <%= index == 0 ? 'show' : '' %>" aria-labelledby="heading<%= room_number %>" data-bs-parent="#roomSchedulesAccordion">
                <div class="accordion-body p-0">
                  <div class="table-responsive">

                    <table class="table table-bordered mb-0">

                      <thead class="table-dark">
                      <tr>
                        <th style="width: 14.28%">Monday</th>
                        <th style="width: 14.28%">Tuesday</th>
                        <th style="width: 14.28%">Wednesday</th>
                        <th style="width: 14.28%">Thursday</th>
                        <th style="width: 14.28%">Friday</th>
                        <th style="width: 14.28%">Saturday</th>
                        <th style="width: 14.28%">Sunday</th>
                      </tr>
                      </thead>

                      <tbody>
                      <tr>
                        <% ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].each do |day| %>
                          <td class="p-2">
                            <div class="d-flex flex-column gap-2">
                              <% schedules_for_day = schedules.select { |s| s.day == day }.sort_by { |s| s.start_time.seconds_since_midnight } %>
                              <% if schedules_for_day.any? %>
                                <% schedules_for_day.each do |schedule| %>
                                  <div class="card schedule-card bg-light border:#06441b">
                                    <div class="card-body p-2">
                                      <h6 class="card-title mb-1 fw-bold"><%= schedule.subject %></h6>
                                      <p class="card-text text-muted mb-1 small">
                                        <i class="bi bi-person-fill me-1"></i> <%= schedule.user.firstname %> <%= schedule.user.lastname %>
                                      </p>

                                      <p class="card-text small fw-bold">
                                        <i class="bi bi-clock-fill me-1"></i> <%= schedule.start_time.strftime('%I:%M %p') %> - <%= schedule.end_time.strftime('%I:%M %p') %>
                                      </p>
                                    </div>
                                  </div>
                                <% end %>
                              <% else %>
                                <div class="text-center text-muted py-3">
                                  <i class="bi bi-x-circle"></i> No Schedule
                                </div>
                              <% end %>
                            </div>
                          </td>
                        <% end %>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-calendar-x fs-1"></i>
          <p class="mt-3">No active room schedules available</p>
        </div>
      <% end %>
    </div>
  </div>
</div>


<script>
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        const speed = 200;

        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target'));
            const inc = target / speed;

            counter.textContent = '0';

            const updateCount = () => {
                const currentCount = parseInt(counter.textContent);
                if (currentCount < target) {
                    counter.textContent = Math.ceil(currentCount + inc);
                    setTimeout(updateCount, 1);
                } else {
                    counter.textContent = target;
                }
            };

            updateCount();
        });

        const progressBars = document.querySelectorAll('.progress-animate');
        progressBars.forEach(bar => {
            const targetWidth = bar.getAttribute('data-width');
            bar.style.width = '0%';

            setTimeout(() => {
                bar.style.width = targetWidth;
            }, 100);
        });
    }

    function initRoomFilter() {
        const roomFilter = document.getElementById('roomFilterDropdown');
        if (!roomFilter) return;

        const roomItems = document.querySelectorAll('.room-schedule-item');

        roomFilter.addEventListener('change', function() {
            const selectedRoom = this.value;

            roomItems.forEach(item => {
                if (selectedRoom === 'all' || item.dataset.room === selectedRoom) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    function setupPaginationLinks() {
        document.querySelectorAll('.pagination a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const url = new URL(this.href);

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        window.location.href = url;
                    })
                    .catch(error => {
                        console.error('Error fetching paginated content:', error);
                        window.location.href = url;
                    });
            });
        });
    }

    function initDashboard() {
        animateCounters();
        initRoomFilter();
        setupPaginationLinks();
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
    document.addEventListener('turbo:load', initDashboard);
    document.addEventListener('turbo:render', initDashboard);

    document.addEventListener('turbo:before-render', function() {
        document.querySelectorAll('.counter').forEach(counter => {
            counter.textContent = '0';
        });

        document.querySelectorAll('.progress-animate').forEach(bar => {
            bar.style.width = '0%';
        });
    });
</script>